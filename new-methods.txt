                
                this.log('ğŸš€ å¹¿å‘Šç‚¹å‡»ç›‘æ§ç³»ç»Ÿå¯åŠ¨ï¼ˆæç®€ç‰ˆï¼‰');
                this.init();
            }
            
            log(...args) {
                if (CONFIG.debugMode) console.log('[AdClick]', ...args);
            }
            
            init() {
                this.checkAds();
                this.setupLeaveDetection();
                this.log('ğŸ’¡ ç­–ç•¥ï¼šç”¨æˆ·ç¦»å¼€é¡µé¢æ—¶è®°å½•ä¸ºå¯èƒ½çš„å¹¿å‘Šç‚¹å‡»');
            }
            
            checkAds() {
                const checkInterval = setInterval(() => {
                    const ads = document.querySelectorAll('.adsbygoogle iframe[id^="aswift_"]');
                    
                    if (ads.length > 0) {
                        this.hasAds = true;
                        this.log(`âœ… æ‰¾åˆ° ${ads.length} ä¸ªå¹¿å‘Š`);
                        clearInterval(checkInterval);
                    }
                }, 500);
                
                setTimeout(() => clearInterval(checkInterval), 10000);
            }
            
            setupLeaveDetection() {
                window.addEventListener('blur', () => {
                    this.log('ğŸ‘ï¸ çª—å£å¤±å»ç„¦ç‚¹');
                    this.onPageLeave('blur');
                });
                
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.log('ğŸšª é¡µé¢éšè—');
                        this.onPageLeave('visibility');
                    }
                });
                
                window.addEventListener('pagehide', () => {
                    this.log('ğŸ“¤ é¡µé¢å¸è½½');
                    this.onPageLeave('pagehide');
                });
                
                this.log('âœ“ ç›‘å¬å™¨å·²è®¾ç½®');
            }
            
            onPageLeave(trigger) {
                if (!this.hasAds) return;
                
                const now = Date.now();
                const lastReport = parseInt(localStorage.getItem(CONFIG.lastReportKey) || '0');
                
                if (now - lastReport < CONFIG.cooldownPeriod) {
                    this.log(`â­ï¸ è·ä¸Šæ¬¡ä¸ŠæŠ¥ä¸è¶³${CONFIG.cooldownPeriod/1000}ç§’`);
                    return;
                }
                
                if (this.reported) {
                    this.log('â­ï¸ æœ¬æ¬¡å·²ä¸ŠæŠ¥');
                    return;
                }
                
                this.log('â•'.repeat(50));
                this.log('ğŸ¯ æ£€æµ‹åˆ°é¡µé¢ç¦»å¼€ï¼Œè®°å½•å¹¿å‘Šç‚¹å‡»');
                this.log('   è§¦å‘:', trigger);
                
                this.reported = true;
                localStorage.setItem(CONFIG.lastReportKey, now.toString());
                
                this.reportClick(trigger);
                
                this.log('âœ… å·²ä¸ŠæŠ¥');
                this.log('â•'.repeat(50));
            }
            
            reportClick(trigger) {
                const totalClicks = this.incrementClicks();
                const stayDuration = Math.round((Date.now() - this.pageLoadTime) / 1000);
                
                const firstAd = document.querySelector('.adsbygoogle');
                const adSlot = firstAd ? firstAd.getAttribute('data-ad-slot') : 'unknown';
                
                const data = {
                    timestamp: new Date().toISOString(),
                    eventType: 'ad_click',
                    novel: '{{ novel.title }}',
                    chapter: '{{ chapter.number }}',
                    pageUrl: window.location.href,
                    adSlot: adSlot,
                    scrollDepth: Math.round(window.scrollY),
                    userIP: '',
                    userAgent: navigator.userAgent,
                    screenSize: `${window.screen.width}x${window.screen.height}`,
                    viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                    stayDuration: stayDuration,
                    totalClickCount: totalClicks,
                    clickSource: trigger + '_simple',
                    referrer: document.referrer
                };
                
                this.sendData(data);
            }
            
            async sendData(data) {
                try {
                    if (typeof getUserIP === 'function') {
                        data.userIP = await getUserIP();
                    } else {
                        try {
                            const res = await fetch('https://api.ipify.org?format=json');
                            const json = await res.json();
                            data.userIP = json.ip;
                        } catch (e) {
                            data.userIP = 'Unknown';
                        }
                    }
                    
                    const payload = JSON.stringify(data);
                    
                    if (navigator.sendBeacon) {
                        const blob = new Blob([payload], {type: 'application/json'});
                        navigator.sendBeacon(CONFIG.scriptUrl, blob);
                        this.log('ğŸ“¡ sendBeacon å‘é€');
                    } else {
                        fetch(CONFIG.scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {'Content-Type': 'application/json'},
                            body: payload,
                            keepalive: true
                        });
                        this.log('ğŸ“¡ fetch å‘é€');
                    }
                    
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'ad_click', {
                            ad_slot: data.adSlot,
                            total_clicks: data.totalClickCount
                        });
                    }
                    
                } catch (error) {
                    this.log('âŒ å‘é€å¤±è´¥:', error);
                }
            }
            
            incrementClicks() {
                try {
                    let total = parseInt(localStorage.getItem(CONFIG.storageKey) || '0');
                    total++;
                    localStorage.setItem(CONFIG.storageKey, total.toString());
                    return total;
                } catch (e) {
                    return 0;
                }
            }
